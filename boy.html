<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deteksi Hama Berdasarkan Umur Tanaman</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --accent:#10703a; --muted:#6b7280;
    }
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#0b1220}
    .container{max-width:1000px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(12,18,32,0.06)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text],select,textarea,input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef3;font-size:14px}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);border:0;color:white;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(16,112,58,0.12)}
    .symptoms{display:flex;gap:8px;flex-wrap:wrap}
    .symptoms label{background:#f3f8f4;padding:6px 8px;border-radius:18px;cursor:pointer;border:1px solid transparent}
    .symptoms input{margin-right:6px}
    .results{margin-top:12px}
    .pest{padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfeff);border:1px solid #edf6ee;margin-bottom:10px}
    .meta{font-size:13px;color:var(--muted)}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Deteksi Hama — Umur & Gejala</h1>
      <div class="controls">
        <button id="addDataBtn">+ Tambah Hama</button>
        <button id="exportBtn">Export CSV</button>
      </div>
    </header>

    <section class="card" style="margin-top:12px;">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <label>Jenis Tanaman</label>
          <select id="cropSelect">
            <option value="semua">— Semua —</option>
            <option value="padi">Padi</option>
            <option value="jagung">Jagung</option>
            <option value="tomat">Tomat</option>
            <option value="sayuran">Sayuran (selada, pakcoy)</option>
            <option value="buah">Buah (pepaya, jeruk, mangga)</option>
          </select>
        </div>

        <div style="min-width:180px">
          <label>Umur Tanaman</label>
          <div style="display:flex;gap:8px">
            <input id="ageValue" type="number" min="0" value="4" />
            <select id="ageUnit" title="Unit umur">
              <option value="hari">Hari</option>
              <option value="minggu" selected>Minggu</option>
              <option value="bulan">Bulan</option>
            </select>
          </div>
        </div>

        <div style="flex:1;min-width:260px">
          <label>Gejala / Observasi (pilih)</label>
          <div class="symptoms" id="symptomsList">
            <label><input type="checkbox" value="daun_kuning" /> Daun menguning</label>
            <label><input type="checkbox" value="lubang_daun" /> Lubang pada daun</label>
            <label><input type="checkbox" value="sayatan_daun" /> Sayatan/terpotong</label>
            <label><input type="checkbox" value="bintik_daun" /> Bintik pada daun</label>
            <label><input type="checkbox" value="busuk_buah" /> Buah busuk</label>
            <label><input type="checkbox" value="serbuk_lilin" /> Serbuk / lapisan lilin</label>
            <label><input type="checkbox" value="akar_bengkak" /> Akar bengkak / kerdil</label>
            <label><input type="checkbox" value="tanaman_menggulung" /> Daun menggulung</label>
            <label><input type="checkbox" value="lubang_buah" /> Lubang di buah</label>
          </div>
        </div>

        <div style="flex-basis:100%;display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button id="detectBtn">Deteksi Hama</button>
          <button id="clearBtn" class="ghost">Reset</button>
        </div>
      </div>

      <div class="results" id="results" aria-live="polite"></div>
      <footer>Catatan: hasil adalah daftar kemungkinan berdasarkan waktu & gejala; selalu konfirmasi dengan pemeriksaan lapang & literatur.</footer>
    </section>
  </div>

  <!-- Modal sederhana untuk tambah data -->
  <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center">
    <div style="background:#fff;padding:14px;border-radius:10px;max-width:720px;width:95%">
      <h3 id="modalTitle">Tambah Hama</h3>
      <form id="pestForm">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label>Nama Hama<input id="p_name" required type="text" /></label>
            <label>Nama Latin<input id="p_latin" type="text" /></label>
            <label>Klasifikasi<input id="p_class" type="text" /></label>
            <label>Tanaman terkait (kata kunci, koma pisah)<input id="p_crops" type="text" placeholder="padi,jagung,tomat,semua" /></label>
          </div>
          <div>
            <label>Morfologi<textarea id="p_morph" rows="5"></textarea></label>
            <label>Cara Pengendalian<textarea id="p_control" rows="4"></textarea></label>
            <label>Umur rentang (min-max) + unit (hari/minggu/bulan)<br />
              <input id="p_age_min" type="number" placeholder="min" style="width:30%;display:inline-block" /> -
              <input id="p_age_max" type="number" placeholder="max" style="width:30%;display:inline-block" />
              <select id="p_age_unit" style="width:30%;display:inline-block">
                <option value="hari">Hari</option>
                <option value="minggu" selected>Minggu</option>
                <option value="bulan">Bulan</option>
              </select>
            </label>
            <label>Gejala tipikal (pisah koma)<input id="p_symptoms" type="text" placeholder="lubang_daun,daun_kuning" /></label>
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
          <button type="button" id="cancelModal" class="ghost">Batal</button>
          <button type="submit">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ====== DATA AWAL (bisa ditambah melalui modal) ======
    const defaultPests = [
      {
        id: 1,
        name: 'Kutu Daun',
        latin: 'Aphidoidea',
        classification: 'Insecta / Hemiptera',
        crops: ['sayuran','tomat','semua'],
        morphology: 'Serangga kecil, tubuh lunak, terkumpul pada bagian bawah daun, mengisap getah.',
        control: {
          early: 'Semprot air, pengamatan, musuh alami (Aphidius).',
          mid: 'Insektisida selektif kontak atau sistemik bila populasi tinggi.',
          late: 'Pertimbangkan pengendalian kimia terukur; rotasi tanaman.'
        },
        age: {min:0,max:8,unit:'minggu'}, // menyerang muda sampai 8 minggu
        symptoms: ['daun_kuning','tanaman_menggulung']
      },
      {
        id: 2,
        name: 'Ulat Grayak',
        latin: 'Spodoptera litura',
        classification: 'Insecta / Lepidoptera',
        crops: ['sayuran','jagung','tomat','semua'],
        morphology: 'Larva ulat, memotong daun dan makan hingga rusak luas.',
        control: {
          early: 'Kontrol mekanik: kumpulkan ulat, perangkap larva.',
          mid: 'Bacillus thuringiensis dan insektisida berbasis rotasi.',
          late: 'Insektisida sesuai label dan sanitasi lahan.'
        },
        age: {min:2,max:20,unit:'minggu'},
        symptoms: ['lubang_daun','sayatan_daun']
      },
      {
        id: 3,
        name: 'Lalat Buah',
        latin: 'Bactrocera dorsalis',
        classification: 'Insecta / Diptera',
        crops: ['buah','tomat','semua'],
        morphology: 'Serangga kecil, betina bertelur dalam buah; larva merusak isi buah.',
        control: {
          early: 'Perangkap massa & sanitasi buah gugur.',
          mid: 'Perangkap umpan & aplikasi insektisida selektif.',
          late: 'Buang buah terserang; penanganan pascapanen.'
        },
        age: {min:6,max:99,unit:'minggu'},
        symptoms: ['busuk_buah','lubang_buah']
      },
      {
        id: 4,
        name: 'Nematoda Akar (Meloidogyne)',
        latin: 'Meloidogyne spp.',
        classification: 'Nematoda',
        crops: ['padi','sayuran','semua'],
        morphology: 'Mikroskopis; menyebabkan galls/bengkak pada akar, pertumbuhan kerdil.',
        control: {
          early: 'Rotasi tanaman, sanitasi dan benih sehat.',
          mid: 'Pengolahan tanah dan biokontrol jika tersedia.',
          late: 'Ganti lahan atau penggunaan varietas tahan.'
        },
        age: {min:0,max:99,unit:'minggu'},
        symptoms: ['akar_bengkak','daun_kuning']
      },
      {
        id: 5,
        name: 'Kumbang Penggerek Batang',
        latin: 'Oryctes/Leucopholis spp.',
        classification: 'Insecta / Coleoptera',
        crops: ['padi','jagung','buah','semua'],
        morphology: 'Kumbang dewasa atau larva menggerek batang atau pangkal tanaman.',
        control: {
          early: 'Sanitasi, pengamatan akar/batang.',
          mid: 'Perangkap feromon, aplikasi insektisida tanah.',
          late: 'Perbaikan tanah dan penggantian tanaman terserang.'
        },
        age: {min:2,max:99,unit:'minggu'},
        symptoms: ['tanaman_menggulung','daun_kuning']
      }
    ];

    // load data from localStorage or use default
    let pests = JSON.parse(localStorage.getItem('pests_by_age')) || defaultPests.slice();

    // util: convert user-entered age to days for internal comparison
    function ageToDays(value, unit) {
      value = Number(value) || 0;
      if (unit === 'hari') return value;
      if (unit === 'minggu') return value * 7;
      if (unit === 'bulan') return value * 30;
      return value;
    }
    // convert pest age (min/max + unit) to days too
    function pestAgeRangeInDays(p) {
      const u = p.age.unit || 'minggu';
      return {min: ageToDays(p.age.min, u), max: ageToDays(p.age.max, u)};
    }

    // DOM refs
    const detectBtn = document.getElementById('detectBtn');
    const cropSelect = document.getElementById('cropSelect');
    const ageValue = document.getElementById('ageValue');
    const ageUnit = document.getElementById('ageUnit');
    const symptomsList = document.getElementById('symptomsList');
    const resultsEl = document.getElementById('results');
    const clearBtn = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn');
    const addDataBtn = document.getElementById('addDataBtn');

    // ---------- Detection logic ----------
    function detect() {
      const crop = (cropSelect.value || 'semua').toLowerCase();
      const ageV = Number(ageValue.value) || 0;
      const ageU = ageUnit.value || 'minggu';
      const ageDays = ageToDays(ageV, ageU);

      // collect selected symptoms
      const checked = [...symptomsList.querySelectorAll('input[type=checkbox]:checked')].map(i => i.value);

      // scoring function: match crop + overlap symptoms + age range overlap
      const scored = pests.map(p => {
        let score = 0;
        // crop match: if pest.crops includes 'semua' or crop matches any
        if (!crop || crop === 'semua' || p.crops.includes('semua') || p.crops.includes(crop)) score += 30;

        // symptoms overlap
        const overlap = checked.filter(s => p.symptoms && p.symptoms.includes(s)).length;
        score += overlap * 20; // each matched symptom adds weight

        // age compatibility
        const range = pestAgeRangeInDays(p);
        if (ageDays >= range.min && ageDays <= range.max) score += 30;
        else {
          // if close (within +/- 2 weeks), small bonus
          const diff = Math.min(Math.abs(ageDays - range.min), Math.abs(ageDays - range.max));
          if (diff <= 14) score += 10;
        }

        // more heuristics: if user didn't select symptoms, rely more on crop+age
        if (checked.length === 0 && (score >= 30)) score = score; // keep as is

        return {...p, score};
      });

      // filter and sort by score descending, threshold 15
      const candidates = scored.filter(s => s.score > 10).sort((a,b) => b.score - a.score);

      renderResults(candidates, ageV, ageU, checked);
    }

    // ---------- UI render ----------
    function renderResults(list, ageV, ageU, checked) {
      resultsEl.innerHTML = '';
      if (!list || list.length === 0) {
        resultsEl.innerHTML = '<div class="card" style="padding:14px">Tidak ditemukan hama yang cocok. Coba ubah umur, jenis tanaman, atau pilih gejala yang lain.</div>';
        return;
      }
      // summary
      const summary = document.createElement('div');
      summary.className = 'card';
      summary.style.padding = '10px';
      summary.innerHTML = `<strong>Hasil deteksi — ${list.length} kemungkinan</strong><div style="margin-top:6px;color:var(--muted)">Umur: ${ageV} ${ageU} — Gejala terpilih: ${checked.length?checked.join(', '):'(tidak ada)'}</div>`;
      resultsEl.appendChild(summary);

      list.forEach(p => {
        const el = document.createElement('div');
        el.className = 'pest';
        // Decide pengendalian yang disesuaikan dengan umur (early/mid/late)
        const ageDays = ageToDays(ageValue.value, ageUnit.value);
        const range = pestAgeRangeInDays(p);
        let controlAdvice = '';
        // choose early/mid/late by dividing range into thirds
        const min = range.min, max = Math.max(range.max, min+1);
        const len = max - min;
        if (ageDays <= min + len/3) controlAdvice = p.control.early || p.control.mid || p.control.late || p.control;
        else if (ageDays <= min + 2*len/3) controlAdvice = p.control.mid || p.control.early || p.control.late || p.control;
        else controlAdvice = p.control.late || p.control.mid || p.control.early || p.control;

        el.innerHTML = `
          <div style="display:flex;justify-content:space-between">
            <div>
              <h3 style="margin:0">${escapeHtml(p.name)}</h3>
              <div class="meta">${escapeHtml(p.latin)} — ${escapeHtml(p.classification)}</div>
            </div>
            <div style="text-align:right;color:var(--muted)"><strong>Score: ${p.score}</strong></div>
          </div>
          <div style="margin-top:8px"><strong>Morfologi:</strong> ${escapeHtml(p.morphology)}</div>
          <div style="margin-top:8px"><strong>Usia cocok:</strong> ${p.age.min} - ${p.age.max} ${p.age.unit}</div>
          <div style="margin-top:8px"><strong>Cara pengendalian (direkomendasikan):</strong> ${escapeHtml(typeof controlAdvice === 'object' ? JSON.stringify(controlAdvice) : controlAdvice)}</div>
        `;
        resultsEl.appendChild(el);
      });
    }

    // helper
    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

    // ---------- events ----------
    detectBtn.addEventListener('click', e => {
      detect();
    });

    clearBtn.addEventListener('click', ()=> {
      cropSelect.value = 'semua';
      ageValue.value = 4;
      ageUnit.value = 'minggu';
      symptomsList.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
      resultsEl.innerHTML = '';
    });

    exportBtn.addEventListener('click', ()=>{
      // export pests DB to CSV
      const header = ['Nama Hama','Nama Latin','Klasifikasi','Crops','Morfologi','Cara Pengendalian','AgeMin','AgeMax','AgeUnit','Symptoms'];
      const rows = pests.map(p => [
        p.name, p.latin, p.classification, (p.crops||[]).join('|'), p.morphology,
        JSON.stringify(p.control), p.age.min, p.age.max, p.age.unit, (p.symptoms||[]).join('|')
      ]);
      const csv = [header, ...rows].map(r => r.map(c => `"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'pests_db.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // ---------- modal add/edit ----------
    const modal = document.getElementById('modal');
    const pestForm = document.getElementById('pestForm');
    const p_name = document.getElementById('p_name');
    const p_latin = document.getElementById('p_latin');
    const p_class = document.getElementById('p_class');
    const p_crops = document.getElementById('p_crops');
    const p_morph = document.getElementById('p_morph');
    const p_control = document.getElementById('p_control');
    const p_age_min = document.getElementById('p_age_min');
    const p_age_max = document.getElementById('p_age_max');
    const p_age_unit = document.getElementById('p_age_unit');
    const p_symptoms = document.getElementById('p_symptoms');
    const modalTitle = document.getElementById('modalTitle');

    let editingPestId = null;

    addDataBtn.addEventListener('click', ()=> {
      editingPestId = null;
      modalTitle.textContent = 'Tambah Hama';
      pestForm.reset(); p_age_unit.value = 'minggu';
      modal.style.display = 'flex';
    });

    document.getElementById('cancelModal').addEventListener('click', ()=> modal.style.display = 'none');

    pestForm.addEventListener('submit', e=> {
      e.preventDefault();
      const name = p_name.value.trim();
      if(!name){ alert('Nama hama wajib diisi'); return; }
      const item = {
        id: editingPestId || Date.now(),
        name,
        latin: p_latin.value.trim(),
        classification: p_class.value.trim() || '—',
        crops: p_crops.value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean),
        morphology: p_morph.value.trim(),
        control: {
          early: p_control.value.trim(),
          mid: p_control.value.trim(),
          late: p_control.value.trim()
        },
        age: { min: Number(p_age_min.value) || 0, max: Number(p_age_max.value) || 99, unit: p_age_unit.value || 'minggu' },
        symptoms: p_symptoms.value.split(',').map(s => s.trim()).filter(Boolean)
      };
      if(editingPestId) {
        pests = pests.map(p => p.id === editingPestId ? item : p);
      } else {
        pests.unshift(item);
      }
      persistPests();
      modal.style.display = 'none';
      alert('Data hama tersimpan (local).');
    });

    // persist to localStorage
    function persistPests(){ localStorage.setItem('pests_by_age', JSON.stringify(pests)); }

    // initial persistence ensure
    persistPests();

    // optional: show top candidates on load (simple)
    // detect();

    // Allow pressing Enter in age input to trigger detection
    ageValue.addEventListener('keydown', (e)=> { if(e.key === 'Enter') detect(); } );

    // small UX: close modal on background click
    modal.addEventListener('click', e => { if(e.target === modal) modal.style.display = 'none'; });

    // helper: (optional) function to load example pests from JSON (not used now)
    function loadExampleData(newData) {
      pests = newData;
      persistPests();
    }
  </script>
</body>
</html>